<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.board.seochu.finance.api.board.mapper.BoardMapper">
    <resultMap id="boardResult" type="com.board.seochu.finance.api.board.dto.BoardDto">
        <result column="DOC_NO"   property="docNo"    jdbcType="INTEGER"/>
        <result column="TITLE"    property="title"    jdbcType="VARCHAR" />
        <result column="CONTENT"  property="content"  jdbcType="VARCHAR" />
        <result column="WRITER"   property="writer"   jdbcType="VARCHAR" />
        <result column="REG_DTTM" property="regDttm"  jdbcType="VARCHAR"/>
        <result column="VIEW"     property="view"     jdbcType="INTEGER"/>
        <result column="REPLY"    property="reply"    jdbcType="INTEGER"/>
    </resultMap>

    <select id="getBoardList" resultMap="boardResult" >
        SELECT A.DOC_NO, A.TITLE, A.CONTENT, A.WRITER, A.REG_DTTM, A.VIEW, A.REPLY
          FROM (
            SELECT A.*, (@ROWNUM := @ROWNUM + 1) AS ROWNUM
              FROM (
                SELECT A.DOC_NO, A.TITLE, A.CONTENT, A.WRITER, A.REG_DTTM, A.VIEW, (SELECT COUNT(*) FROM TB_REPLY X WHERE X.DOC_NO = A.DOC_NO) AS REPLY
                  FROM TB_BOARD A
                <where>
                    <if test="boardDto.schType != null and boardDto.schType != '' and boardDto.schVal != null and boardDto.schVal != ''">
                        <choose>
                            <when test="boardDto.schType == 'docNo'">
                                AND A.DOC_NO = #{boardDto.schVal}
                            </when>
                            <when test="boardDto.schType == 'title'">
                                AND A.TITLE LIKE CONCAT('%', #{boardDto.schVal}, '%')
                            </when>
                            <when test="schType == 'writer'">
                                AND A.WRITER LIKE CONCAT('%', #{boardDto.schVal}, '%')
                            </when>
                        </choose>
                    </if>
                </where>
                ORDER BY
                <foreach collection="boardDto.test" item="boardDto.test" index="index" separator=",">
                    ${boardDto.test}
                </foreach>
                ) A, (SELECT @ROWNUM := 0) TEMP
            ) A
         WHERE ROWNUM BETWEEN #{boardDto.startNo} AND #{boardDto.endNo}
    </select>

    <select id="selectBoardListCount" resultType="int" parameterType="com.board.seochu.finance.api.board.dto.BoardDto">
        SELECT COUNT(*) AS TOTAL_CNT
          FROM TB_BOARD
        <where>
            <if test="boardDto.schType != null and boardDto.schType != '' and boardDto.schVal != null and boardDto.schVal != ''">
                <choose>
                    <when test="boardDto.schType == 'docNo'">
                        AND DOC_NO = #{boardDto.schVal}
                    </when>
                    <when test="boardDto.schType == 'title'">
                        AND TITLE LIKE CONCAT('%', #{boardDto.schVal}, '%')
                    </when>
                    <when test="boardDto.schType == 'writer'">
                        AND WRITER LIKE CONCAT('%', #{boardDto.schVal}, '%')
                    </when>
                </choose>
            </if>
        </where>
    </select>

    <insert id="insertBoard" parameterType="com.board.seochu.finance.api.board.dto.BoardDto">
        <selectKey resultType="int" keyProperty="boardDto.docNo" order="BEFORE">
            SELECT IFNULL(MAX(DOC_NO), 0) + 1 AS DOC_NO FROM TB_BOARD
        </selectKey>
        INSERT INTO TB_BOARD (DOC_NO, TITLE, CONTENT, WRITER)
        VALUES (#{boardDto.docNo}, #{boardDto.title}, #{boardDto.content}, #{boardDto.writer})
    </insert>
</mapper>
